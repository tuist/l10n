name: Translate

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    name: Translate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: "!startsWith(github.event.head_commit.message, '[l10n]')"
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Set up mise
        uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2
        with:
          cache: true

      - name: Install tools
        run: mise install

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check translation status
        id: status
        run: |
          if bun run src/cli.ts status; then
            echo "stale=false" >> "$GITHUB_OUTPUT"
          else
            echo "stale=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Authenticate to GCP
        if: steps.status.outputs.stale == 'true'
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Get Vertex AI access token
        if: steps.status.outputs.stale == 'true'
        id: token
        run: echo "token=$(gcloud auth print-access-token)" >> "$GITHUB_OUTPUT"

      - name: Run translations
        if: steps.status.outputs.stale == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          VERTEX_AI_TOKEN: ${{ steps.token.outputs.token }}
          VERTEX_AI_ENDPOINT: ${{ secrets.VERTEX_AI_ENDPOINT }}
        run: bun run src/cli.ts translate

      - name: Create PR with translations
        if: steps.status.outputs.stale == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "No translation changes detected"
            exit 0
          fi

          BRANCH="l10n/update-translations"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "[l10n] Update translations"
          git push --force origin "$BRANCH"

          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists, force-pushed update"
          else
            gh pr create \
              --title "[l10n] Update translations" \
              --body "Automated translation update triggered by push to main." \
              --head "$BRANCH" \
              --base main
          fi
